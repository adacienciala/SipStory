---
import DashboardView from "../components/dashboard/DashboardView";
import Layout from "../layouts/Layout.astro";
import { listTastingNotes } from "../lib/services/tasting-notes.service";

// Get user from middleware
const user = Astro.locals.user;

// Redirect to login if not authenticated
if (!user) {
  return Astro.redirect("/login", 302);
}

// Fetch initial tasting notes
const supabase = Astro.locals.supabase;
const initialData = await listTastingNotes(supabase, user.id, {
  page: 1,
  limit: 12,
  sort_by: "created_at",
  sort_order: "desc",
});

// Redirect to onboarding if user has no tasting notes
if (initialData.data.length === 0) {
  return Astro.redirect("/onboarding", 302);
}
---

<Layout title="Dashboard - SipStory">
  <DashboardView client:load initialData={initialData} />
</Layout>
