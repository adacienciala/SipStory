---
import { TastingForm } from "../../../components/tasting-form/TastingForm";
import Layout from "../../../layouts/Layout.astro";
import { listBlends } from "../../../lib/services/blends.service";
import { listBrands } from "../../../lib/services/brands.service";
import { listRegions } from "../../../lib/services/regions.service";
import { getTastingNoteById } from "../../../lib/services/tasting-notes.service";
import type { TastingNoteResponseDTO } from "../../../types";

export const prerender = false;

// Get the tasting note ID from the URL parameter
const { id } = Astro.params;

// Check if user is authenticated
const supabase = Astro.locals.supabase;
const {
  data: { user },
} = await supabase.auth.getUser();

if (!user) {
  return Astro.redirect("/login");
}

// Validate ID parameter
if (!id) {
  return new Response("Tasting note ID is required", { status: 400 });
}

// Fetch tasting note data and autocomplete data
let initialData: TastingNoteResponseDTO | null = null;
let brands: string[] = [];
let regions: string[] = [];
let blends: string[] = [];
let error: string | null = null;

try {
  // Fetch the tasting note
  initialData = await getTastingNoteById(supabase, user.id, id);

  if (!initialData) {
    error = "Tasting note not found";
  } else {
    // Fetch autocomplete data
    const brandsResult = await listBrands(supabase, { page: 1, limit: 1000 });
    brands = brandsResult.data.map((brand) => brand.name).sort();

    const regionsResult = await listRegions(supabase, { page: 1, limit: 1000 });
    regions = regionsResult.data.map((region) => region.name).sort();

    const blendsResult = await listBlends(supabase, { page: 1, limit: 1000 });
    blends = blendsResult.data.map((blend) => blend.name).sort();
  }
} catch (err) {
  // eslint-disable-next-line no-console
  console.error("Error fetching tasting note:", err);
  error = "An unexpected error occurred while loading the tasting note";
}
---

<Layout title={initialData ? `Edit: ${initialData.blend.brand.name} - ${initialData.blend.name}` : "Edit Tasting Note"}>
  {
    error ? (
      <div class="flex min-h-screen items-center justify-center p-4">
        <div class="max-w-md space-y-4 text-center">
          <h1 class="text-2xl font-bold text-gray-900">{error}</h1>
          <p class="text-gray-600">
            {error === "Tasting note not found"
              ? "The tasting note you're trying to edit doesn't exist or you don't have permission to edit it."
              : "Please try again later or contact support if the problem persists."}
          </p>
          <a
            href="/dashboard"
            class="inline-flex items-center justify-center rounded-md bg-primary px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary/90"
          >
            Back to Dashboard
          </a>
        </div>
      </div>
    ) : initialData ? (
      <div class="container mx-auto max-w-2xl px-4 py-8">
        <div class="mb-6">
          <a href={`/tastings/${id}`} class="inline-flex items-center text-sm text-gray-600 hover:text-gray-900">
            <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            Back to Tasting Note
          </a>
        </div>
        <h1 class="mb-8 text-3xl font-bold text-gray-900">Edit Tasting Note</h1>
        <TastingForm initialData={initialData} brands={brands} regions={regions} blends={blends} client:load />
      </div>
    ) : (
      <div class="flex min-h-screen items-center justify-center">
        <div class="text-center">
          <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-gray-200 border-t-primary" />
          <p class="mt-4 text-gray-600">Loading tasting note...</p>
        </div>
      </div>
    )
  }
</Layout>
