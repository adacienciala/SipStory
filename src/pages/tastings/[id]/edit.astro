---
import BackButton from "../../../components/BackButton.astro";
import { TastingForm } from "../../../components/tasting-form/TastingForm";
import Layout from "../../../layouts/Layout.astro";
import { getTastingNoteById } from "../../../lib/services/tasting-notes.service";
import type { TastingNoteResponseDTO } from "../../../types";

export const prerender = false;

// Get the tasting note ID from the URL parameter
const { id } = Astro.params;

// Check if user is authenticated
const supabase = Astro.locals.supabase;
const {
  data: { user },
} = await supabase.auth.getUser();

if (!user) {
  return Astro.redirect("/login");
}

// Validate ID parameter
if (!id) {
  return new Response("Tasting note ID is required", { status: 400 });
}

// Fetch tasting note data
let initialData: TastingNoteResponseDTO | null = null;
let error: string | null = null;

try {
  // Fetch the tasting note
  initialData = await getTastingNoteById(supabase, user.id, id);

  if (!initialData) {
    error = "Tasting note not found";
  }
} catch (err) {
  // eslint-disable-next-line no-console
  console.error("Error fetching tasting note:", err);
  error = "An unexpected error occurred while loading the tasting note";
}
---

<Layout title={initialData ? `Edit: ${initialData.blend.brand.name} - ${initialData.blend.name}` : "Edit Tasting Note"}>
  {
    error ? (
      <div class="flex min-h-screen items-center justify-center p-4">
        <div class="max-w-md space-y-4 text-center">
          <h1 class="text-2xl font-bold text-gray-900">{error}</h1>
          <p class="text-gray-600">
            {error === "Tasting note not found"
              ? "The tasting note you're trying to edit doesn't exist or you don't have permission to edit it."
              : "Please try again later or contact support if the problem persists."}
          </p>
          <BackButton variant="button" text="Back to Dashboard" />
        </div>
      </div>
    ) : initialData ? (
      <div class="container mx-auto max-w-2xl px-4 py-8">
        <div class="mb-6">
          <BackButton destination={`/tastings/${id}`} text="Back to Tasting Note" />
        </div>
        <h1 class="mb-8 text-3xl font-bold text-gray-900">Edit Tasting Note</h1>
        <TastingForm initialData={initialData} client:load />
      </div>
    ) : (
      <div class="flex min-h-screen items-center justify-center">
        <div class="text-center">
          <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-gray-200 border-t-primary" />
          <p class="mt-4 text-gray-600">Loading tasting note...</p>
        </div>
      </div>
    )
  }
</Layout>
